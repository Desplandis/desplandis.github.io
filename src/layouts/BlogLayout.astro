---
import BaseLayout from './BaseLayout.astro';
import Header from '@components/layout/Header.astro';
import Footer from '@components/layout/Footer.astro';
import Badge from '@components/ui/Badge.astro';
import Tag from '@components/ui/Tag.astro';
import { formatDate } from '@utils/dates';
import { calculateReadingTime } from '@utils/content';

interface Props {
  title: string;
  summary: string;
  publishDate: Date;
  updatedDate?: Date;
  audience: 'developers' | 'executives' | 'both';
  tags: string[];
  author?: string;
  featured?: boolean;
  rawContent?: string;
  // Navigation
  prevPost?: { slug: string; title: string } | null;
  nextPost?: { slug: string; title: string } | null;
}

const {
  title,
  summary,
  publishDate,
  updatedDate,
  audience,
  tags,
  author,
  featured,
  rawContent = '',
  prevPost,
  nextPost,
} = Astro.props;

const readingTime = calculateReadingTime(rawContent);
const publishDateISO = publishDate.toISOString();
const updatedDateISO = updatedDate?.toISOString();

// Structured data for SEO (JSON-LD)
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description: summary,
  datePublished: publishDateISO,
  dateModified: updatedDateISO || publishDateISO,
  author: author
    ? { '@type': 'Person', name: author }
    : { '@type': 'Organization', name: 'iTowns Contributors' },
  publisher: {
    '@type': 'Organization',
    name: 'iTowns',
    url: 'https://itowns.org',
  },
};
---

<BaseLayout title={title} description={summary}>
  <Header />

  <main id="main-content">
    <article class="blog-post" itemscope itemtype="https://schema.org/BlogPosting">
      <div class="container">
        <!-- Article Header -->
        <header class="post-header">
          <div class="post-meta-top">
            <Badge audience={audience} />
            {featured && <span class="featured-badge">Featured</span>}
          </div>

          <h1 itemprop="headline">{title}</h1>

          <p class="post-summary" itemprop="description">{summary}</p>

          <div class="post-meta">
            <div class="meta-row">
              <time datetime={publishDateISO} itemprop="datePublished">
                {formatDate(publishDate)}
              </time>

              {
                updatedDate && (
                  <span class="updated">
                    <span class="sr-only">Updated:</span>
                    <time datetime={updatedDateISO} itemprop="dateModified">
                      Updated {formatDate(updatedDate, 'short')}
                    </time>
                  </span>
                )
              }

              {
                readingTime > 0 && (
                  <span class="reading-time">
                    <span aria-hidden="true">·</span>
                    {readingTime} min read
                  </span>
                )
              }
            </div>

            {
              author && (
                <div class="author" itemprop="author" itemscope itemtype="https://schema.org/Person">
                  <span>By </span>
                  <span itemprop="name">{author}</span>
                </div>
              )
            }
          </div>

          {
            tags && tags.length > 0 && (
              <nav class="post-tags" aria-label="Post tags">
                {tags.map((tag) => (
                  <a href={`/blog/tag/${tag}`} class="tag-link">
                    <Tag size="sm">{tag}</Tag>
                  </a>
                ))}
              </nav>
            )
          }
        </header>

        <!-- Article Content -->
        <div class="post-content" itemprop="articleBody">
          <slot />
        </div>

        <!-- Article Footer -->
        <footer class="post-footer">
          {
            author && (
              <div class="author-section">
                <p>
                  <strong>Written by {author}</strong>
                </p>
                <p class="author-note">
                  iTowns is maintained by a community of contributors. Want to
                  contribute?{' '}
                  <a href="/community">Join the community</a>.
                </p>
              </div>
            )
          }

          <div class="share-section">
            <p class="share-label">Share this post:</p>
            <div class="share-links">
              <a
                href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(`https://itowns.org/blog/${Astro.params.slug}`)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="share-link"
              >
                Twitter
              </a>
              <a
                href={`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(`https://itowns.org/blog/${Astro.params.slug}`)}&title=${encodeURIComponent(title)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="share-link"
              >
                LinkedIn
              </a>
            </div>
          </div>

          {
            (prevPost || nextPost) && (
              <nav class="post-navigation" aria-label="Blog navigation">
                <div class="nav-links">
                  {prevPost ? (
                    <a href={`/blog/${prevPost.slug}`} class="nav-link prev">
                      <span class="nav-label">← Previous</span>
                      <span class="nav-title">{prevPost.title}</span>
                    </a>
                  ) : (
                    <span />
                  )}

                  {nextPost && (
                    <a href={`/blog/${nextPost.slug}`} class="nav-link next">
                      <span class="nav-label">Next →</span>
                      <span class="nav-title">{nextPost.title}</span>
                    </a>
                  )}
                </div>
              </nav>
            )
          }

          <div class="back-to-blog">
            <a href="/blog">← Back to all posts</a>
          </div>
        </footer>
      </div>
    </article>
  </main>

  <Footer />

  <!-- Structured Data -->
  <script
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify(structuredData)}
  />
</BaseLayout>

<style>
  .blog-post {
    padding: var(--space-8) 0;
  }

  .container {
    max-width: var(--container-max-width);
    margin: 0 auto;
    padding: 0 var(--container-padding);
  }

  /* Header */
  .post-header {
    max-width: 720px;
    margin-bottom: var(--space-8);
  }

  .post-meta-top {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .featured-badge {
    padding: var(--space-1) var(--space-2);
    background-color: rgba(234, 88, 12, 0.1);
    color: var(--color-warning);
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-radius: var(--radius-sm);
  }

  .post-header h1 {
    font-size: var(--text-4xl);
    line-height: var(--leading-tight);
    margin-bottom: var(--space-4);
  }

  .post-summary {
    font-size: var(--text-xl);
    color: var(--color-text-secondary);
    line-height: var(--leading-relaxed);
    margin-bottom: var(--space-5);
  }

  .post-meta {
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-5);
  }

  .meta-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-2);
  }

  .updated {
    font-style: italic;
  }

  .reading-time {
    color: var(--color-text-tertiary);
  }

  .author {
    color: var(--color-text-secondary);
  }

  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .tag-link {
    text-decoration: none;
  }

  .tag-link:hover {
    text-decoration: none;
  }

  /* Content */
  .post-content {
    max-width: 720px;
    margin-bottom: var(--space-8);
  }

  /* Typography in content */
  .post-content :global(h2) {
    font-size: var(--text-3xl);
    margin-top: var(--space-9);
    margin-bottom: var(--space-4);
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border);
  }

  .post-content :global(h2:first-child) {
    margin-top: 0;
    padding-top: 0;
    border-top: none;
  }

  .post-content :global(h3) {
    font-size: var(--text-2xl);
    margin-top: var(--space-7);
    margin-bottom: var(--space-3);
  }

  .post-content :global(h4) {
    font-size: var(--text-xl);
    margin-top: var(--space-6);
    margin-bottom: var(--space-3);
  }

  .post-content :global(p) {
    margin-bottom: var(--space-4);
    line-height: var(--leading-relaxed);
  }

  .post-content :global(ul),
  .post-content :global(ol) {
    margin-bottom: var(--space-4);
    padding-left: var(--space-5);
  }

  .post-content :global(li) {
    margin-bottom: var(--space-2);
    line-height: var(--leading-relaxed);
  }

  .post-content :global(blockquote) {
    margin: var(--space-6) 0;
    padding: var(--space-4) var(--space-5);
    border-left: 4px solid var(--color-accent-primary);
    background-color: var(--color-bg-secondary);
    font-style: italic;
  }

  .post-content :global(blockquote p:last-child) {
    margin-bottom: 0;
  }

  .post-content :global(pre) {
    margin: var(--space-5) 0;
    padding: var(--space-4);
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    overflow-x: auto;
  }

  .post-content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    margin: var(--space-6) 0;
  }

  .post-content :global(hr) {
    margin: var(--space-8) 0;
    border: none;
    border-top: 1px solid var(--color-border);
  }

  .post-content :global(table) {
    width: 100%;
    margin: var(--space-5) 0;
    border-collapse: collapse;
  }

  .post-content :global(th),
  .post-content :global(td) {
    padding: var(--space-3);
    text-align: left;
    border-bottom: 1px solid var(--color-border);
  }

  .post-content :global(th) {
    font-weight: 600;
    background-color: var(--color-bg-secondary);
  }

  /* Footer */
  .post-footer {
    max-width: 720px;
    padding-top: var(--space-6);
    border-top: 1px solid var(--color-border);
  }

  .author-section {
    margin-bottom: var(--space-6);
  }

  .author-note {
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
  }

  .share-section {
    margin-bottom: var(--space-6);
  }

  .share-label {
    font-size: var(--text-sm);
    font-weight: 500;
    margin-bottom: var(--space-2);
    color: var(--color-text-secondary);
  }

  .share-links {
    display: flex;
    gap: var(--space-3);
  }

  .share-link {
    padding: var(--space-2) var(--space-3);
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .share-link:hover {
    background-color: var(--color-bg-tertiary);
    color: var(--color-text-primary);
    text-decoration: none;
  }

  .post-navigation {
    margin-bottom: var(--space-6);
    padding: var(--space-5) 0;
    border-top: 1px solid var(--color-border);
    border-bottom: 1px solid var(--color-border);
  }

  .nav-links {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
  }

  .nav-link {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    padding: var(--space-3);
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: background-color var(--transition-fast);
  }

  .nav-link:hover {
    background-color: var(--color-bg-tertiary);
    text-decoration: none;
  }

  .nav-link.next {
    text-align: right;
  }

  .nav-label {
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .nav-title {
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text-primary);
    line-height: var(--leading-tight);
  }

  .back-to-blog {
    text-align: center;
  }

  .back-to-blog a {
    font-size: var(--text-sm);
    color: var(--color-accent-primary);
  }

  /* Accessibility */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .blog-post {
      padding: var(--space-6) 0;
    }

    .post-header h1 {
      font-size: var(--text-3xl);
    }

    .post-summary {
      font-size: var(--text-lg);
    }

    .meta-row {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-2);
    }

    .nav-links {
      grid-template-columns: 1fr;
    }

    .nav-link.next {
      text-align: left;
    }
  }
</style>
