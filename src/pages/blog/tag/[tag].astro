---
import BlogLayout from '@layouts/BlogLayout.astro';
import { getCollection } from 'astro:content';
import { sortByDateDesc, filterDrafts } from '@utils/dates';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const publishedPosts = filterDrafts(allPosts);

  // Get all unique tags
  const allTags = [...new Set(publishedPosts.flatMap((post) => post.data.tags))];

  return allTags.map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: sortByDateDesc(
        publishedPosts.filter((post) => post.data.tags.includes(tag))
      ),
    },
  }));
}

const { tag, posts } = Astro.props;

// Get all tags for filtering
const allPosts = await getCollection('blog');
const publishedPosts = filterDrafts(allPosts);
const allTags = [...new Set(publishedPosts.flatMap((post) => post.data.tags))].sort();
---

<BlogLayout
  title={`Posts tagged "${tag}"`}
  description={`All blog posts about ${tag} from the iTowns community.`}
  posts={posts}
  allTags={allTags}
  currentTag={tag}
/>
