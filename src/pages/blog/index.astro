---
import PageLayout from '@layouts/PageLayout.astro';
import Container from '@components/ui/Container.astro';
import Badge from '@components/ui/Badge.astro';
import Tag from '@components/ui/Tag.astro';
import { getCollection } from 'astro:content';
import { formatDate, sortByDateDesc, filterDrafts } from '@utils/dates';
import { calculateReadingTime } from '@utils/content';

// Get all published posts
const allPosts = await getCollection('blog');
const publishedPosts = sortByDateDesc(filterDrafts(allPosts));

// Separate featured posts
const featuredPosts = publishedPosts.filter((post) => post.data.featured);
const regularPosts = publishedPosts.filter((post) => !post.data.featured);

// Get all unique tags
const allTags = [
  ...new Set(publishedPosts.flatMap((post) => post.data.tags)),
].sort();

// Group posts by audience for filtering reference
const audienceCounts = {
  all: publishedPosts.length,
  developers: publishedPosts.filter((p) => p.data.audience === 'developers')
    .length,
  executives: publishedPosts.filter((p) => p.data.audience === 'executives')
    .length,
  both: publishedPosts.filter((p) => p.data.audience === 'both').length,
};
---

<PageLayout
  title="Blog"
  description="Framework updates, governance communication, and technical insights from the iTowns community. A first-class communication channel for developers and decision-makers."
>
  <div class="blog-index">
    <Container>
      <!-- Page Header -->
      <header class="page-header">
        <h1>Blog</h1>
        <p class="page-description">
          Framework updates, governance communication, and technical insights
          from the iTowns community.
        </p>
        <p class="blog-purpose">
          The blog is a first-class communication channelâ€”not a marketing
          afterthought. Here you'll find transparent updates on framework
          evolution, governance decisions, and technical deep-dives.
        </p>
      </header>

      <!-- Audience Filter (Static links for accessibility) -->
      <nav class="audience-filter" aria-label="Filter by audience">
        <span class="filter-label">Filter by audience:</span>
        <div class="filter-options">
          <a href="/blog" class="filter-option active">
            All ({audienceCounts.all})
          </a>
          <a href="/blog/audience/developers" class="filter-option">
            Developers ({audienceCounts.developers})
          </a>
          <a href="/blog/audience/executives" class="filter-option">
            Decision-Makers ({audienceCounts.executives})
          </a>
        </div>
      </nav>

      <!-- Featured Posts (if any) -->
      {
        featuredPosts.length > 0 && (
          <section class="featured-section" aria-labelledby="featured-heading">
            <h2 id="featured-heading" class="section-heading">
              Featured Posts
            </h2>
            <div class="featured-grid">
              {featuredPosts.slice(0, 2).map((post) => (
                <article class="featured-post">
                  <a href={`/blog/${post.slug}`} class="featured-link">
                    <div class="featured-meta">
                      <Badge audience={post.data.audience} />
                      <span class="featured-badge">Featured</span>
                    </div>
                    <h3>{post.data.title}</h3>
                    <p class="featured-summary">{post.data.summary}</p>
                    <div class="featured-footer">
                      <time datetime={post.data.publishDate.toISOString()}>
                        {formatDate(post.data.publishDate)}
                      </time>
                      <span class="reading-time">
                        {calculateReadingTime(post.body)} min read
                      </span>
                    </div>
                  </a>
                </article>
              ))}
            </div>
          </section>
        )
      }

      <!-- All Posts -->
      <section class="posts-section" aria-labelledby="posts-heading">
        <h2 id="posts-heading" class="section-heading">
          {featuredPosts.length > 0 ? 'All Posts' : 'Posts'}
        </h2>

        {
          regularPosts.length > 0 || featuredPosts.length > 0 ? (
            <div class="posts-list">
              {(featuredPosts.length > 0 ? regularPosts : publishedPosts).map(
                (post) => (
                  <article class="post-item">
                    <a href={`/blog/${post.slug}`} class="post-link">
                      <div class="post-content">
                        <div class="post-meta-top">
                          <Badge audience={post.data.audience} />
                          <time datetime={post.data.publishDate.toISOString()}>
                            {formatDate(post.data.publishDate, 'short')}
                          </time>
                        </div>

                        <h3 class="post-title">{post.data.title}</h3>

                        <p class="post-summary">{post.data.summary}</p>

                        <div class="post-footer">
                          <div class="post-tags">
                            {post.data.tags.slice(0, 3).map((tag) => (
                              <span class="post-tag">{tag}</span>
                            ))}
                          </div>
                          <span class="reading-time">
                            {calculateReadingTime(post.body)} min read
                          </span>
                        </div>
                      </div>
                    </a>
                  </article>
                )
              )}
            </div>
          ) : (
            <div class="no-posts">
              <p>No blog posts published yet.</p>
              <p class="no-posts-sub">
                Check back soon for framework updates, governance decisions, and
                technical insights.
              </p>
            </div>
          )
        }
      </section>

      <!-- Tags Sidebar -->
      {
        allTags.length > 0 && (
          <aside class="tags-section" aria-labelledby="tags-heading">
            <h2 id="tags-heading" class="section-heading">
              Browse by Topic
            </h2>
            <nav class="tags-list" aria-label="Browse posts by tag">
              {allTags.map((tag) => (
                <a href={`/blog/tag/${tag}`} class="tag-link">
                  <Tag>{tag}</Tag>
                </a>
              ))}
            </nav>
          </aside>
        )
      }

      <!-- Subscribe/RSS -->
      <section class="subscribe-section">
        <h2 class="section-heading">Stay Updated</h2>
        <p>
          Subscribe to the iTowns blog via RSS to receive updates on framework
          development, governance decisions, and community news.
        </p>
        <a href="/rss.xml" class="rss-link">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="currentColor"
            aria-hidden="true"
          >
            <circle cx="6.18" cy="17.82" r="2.18"></circle>
            <path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"
            ></path>
          </svg>
          RSS Feed
        </a>
      </section>
    </Container>
  </div>
</PageLayout>

<style>
  .blog-index {
    padding: var(--space-8) 0 var(--space-9);
  }

  /* Page Header */
  .page-header {
    text-align: center;
    max-width: 800px;
    margin: 0 auto var(--space-8);
  }

  .page-header h1 {
    margin-bottom: var(--space-4);
  }

  .page-description {
    font-size: var(--text-xl);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-3);
  }

  .blog-purpose {
    font-size: var(--text-base);
    color: var(--color-text-tertiary);
    font-style: italic;
  }

  /* Audience Filter */
  .audience-filter {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4);
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-8);
  }

  .filter-label {
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text-secondary);
  }

  .filter-options {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .filter-option {
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .filter-option:hover {
    background-color: var(--color-bg-tertiary);
    text-decoration: none;
  }

  .filter-option.active {
    background-color: var(--color-text-primary);
    color: var(--color-bg-primary);
  }

  /* Section Heading */
  .section-heading {
    font-size: var(--text-2xl);
    margin-bottom: var(--space-5);
  }

  /* Featured Posts */
  .featured-section {
    margin-bottom: var(--space-9);
  }

  .featured-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: var(--space-5);
  }

  .featured-post {
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: box-shadow var(--transition-fast);
  }

  .featured-post:hover {
    box-shadow: var(--shadow-md);
  }

  .featured-link {
    display: block;
    padding: var(--space-6);
    text-decoration: none;
    color: inherit;
  }

  .featured-link:hover {
    text-decoration: none;
  }

  .featured-meta {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
  }

  .featured-badge {
    padding: var(--space-1) var(--space-2);
    background-color: rgba(234, 88, 12, 0.1);
    color: var(--color-warning);
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-radius: var(--radius-sm);
  }

  .featured-post h3 {
    font-size: var(--text-2xl);
    margin-bottom: var(--space-3);
    color: var(--color-text-primary);
  }

  .featured-summary {
    font-size: var(--text-base);
    color: var(--color-text-secondary);
    line-height: var(--leading-relaxed);
    margin-bottom: var(--space-4);
  }

  .featured-footer {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
  }

  /* Posts List */
  .posts-section {
    margin-bottom: var(--space-8);
  }

  .posts-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .post-item {
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    transition: all var(--transition-fast);
  }

  .post-item:hover {
    border-color: var(--color-accent-primary);
    box-shadow: var(--shadow-sm);
  }

  .post-link {
    display: block;
    padding: var(--space-5);
    text-decoration: none;
    color: inherit;
  }

  .post-link:hover {
    text-decoration: none;
  }

  .post-meta-top {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-3);
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
  }

  .post-title {
    font-size: var(--text-xl);
    margin-bottom: var(--space-2);
    color: var(--color-text-primary);
  }

  .post-summary {
    font-size: var(--text-base);
    color: var(--color-text-secondary);
    line-height: var(--leading-relaxed);
    margin-bottom: var(--space-3);
  }

  .post-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: var(--space-3);
  }

  .post-tags {
    display: flex;
    gap: var(--space-2);
  }

  .post-tag {
    padding: var(--space-1) var(--space-2);
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
  }

  .reading-time {
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
  }

  /* No Posts */
  .no-posts {
    text-align: center;
    padding: var(--space-8);
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
  }

  .no-posts p {
    font-size: var(--text-lg);
    margin-bottom: var(--space-2);
  }

  .no-posts-sub {
    font-size: var(--text-base);
    color: var(--color-text-tertiary);
  }

  /* Tags Section */
  .tags-section {
    margin-bottom: var(--space-8);
    padding: var(--space-5);
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
  }

  .tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .tag-link {
    text-decoration: none;
  }

  .tag-link:hover {
    text-decoration: none;
  }

  /* Subscribe Section */
  .subscribe-section {
    text-align: center;
    padding: var(--space-6);
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
  }

  .subscribe-section p {
    max-width: 600px;
    margin: 0 auto var(--space-4);
    color: var(--color-text-secondary);
  }

  .rss-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    background-color: var(--color-accent-primary);
    color: white;
    border-radius: var(--radius-md);
    font-weight: 500;
    text-decoration: none;
    transition: background-color var(--transition-fast);
  }

  .rss-link:hover {
    background-color: var(--color-accent-hover);
    text-decoration: none;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .blog-index {
      padding: var(--space-6) 0 var(--space-7);
    }

    .audience-filter {
      flex-direction: column;
      align-items: flex-start;
    }

    .featured-grid {
      grid-template-columns: 1fr;
    }

    .post-footer {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>
