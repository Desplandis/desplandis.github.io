---
import PageLayout from '@layouts/PageLayout.astro';
import Card from '@components/ui/Card.astro';
import Badge from '@components/ui/Badge.astro';
import { getCollection } from 'astro:content';

const features = await getCollection('features');
const sortedFeatures = features
  .filter((f) => !f.data.draft)
  .sort((a, b) => (a.data.order || 999) - (b.data.order || 999));

// Group by category
const featuresByCategory = sortedFeatures.reduce(
  (acc, feature) => {
    const category = feature.data.category;
    if (!acc[category]) acc[category] = [];
    acc[category].push(feature);
    return acc;
  },
  {} as Record<string, typeof sortedFeatures>
);

const categoryLabels: Record<string, string> = {
  visualization: 'Visualization',
  'data-sources': 'Data Sources',
  interaction: 'Interaction',
  analysis: 'Analysis',
  integration: 'Integration',
  performance: 'Performance',
};

const categoryDescriptions: Record<string, string> = {
  visualization: 'Rendering, styling, and visual effects for 3D scenes',
  'data-sources': 'Support for geospatial data formats and protocols',
  interaction: 'Navigation controls, picking, and user interaction',
  analysis: 'Measurement, processing, and spatial queries',
  integration: 'APIs, frameworks, and extension capabilities',
  performance: 'Optimization, caching, and streaming techniques',
};

// Define category order
const categoryOrder = [
  'visualization',
  'data-sources',
  'interaction',
  'analysis',
  'integration',
  'performance',
];

const sortedCategories = Object.entries(featuresByCategory).sort(
  ([a], [b]) => categoryOrder.indexOf(a) - categoryOrder.indexOf(b)
);

// Featured features for hero
const featuredFeatures = sortedFeatures.filter((f) => f.data.featured);
---

<PageLayout
  title="Features"
  description="Explore iTowns' comprehensive feature set for 3D geospatial visualization, data loading, interaction, and analysis."
>
  <div class="features-page">
    <div class="container">
      <!-- Header -->
      <header class="page-header">
        <h1>Features</h1>
        <p class="page-description">
          iTowns provides a comprehensive toolkit for building 3D geospatial
          applications. Explore capabilities organized by category.
        </p>
      </header>

      <!-- Featured Features -->
      {
        featuredFeatures.length > 0 && (
          <section class="featured-section">
            <h2>Key Capabilities</h2>
            <div class="featured-grid">
              {featuredFeatures.map((feature) => (
                <a href={`/features/${feature.slug}`} class="featured-card">
                  <div class="featured-meta">
                    <span class="category-tag">
                      {categoryLabels[feature.data.category] ||
                        feature.data.category}
                    </span>
                    {feature.data.comingSoon && (
                      <span class="coming-soon">Coming Soon</span>
                    )}
                  </div>
                  <h3>{feature.data.title}</h3>
                  <p>{feature.data.summary}</p>
                  {feature.data.capabilities && (
                    <ul class="capabilities-preview">
                      {feature.data.capabilities.slice(0, 3).map((cap) => (
                        <li>{cap}</li>
                      ))}
                    </ul>
                  )}
                </a>
              ))}
            </div>
          </section>
        )
      }

      <!-- Features by Category -->
      {
        sortedCategories.map(([category, categoryFeatures]) => (
          <section class="category-section">
            <div class="category-header">
              <h2>{categoryLabels[category] || category}</h2>
              {categoryDescriptions[category] && (
                <p class="category-description">
                  {categoryDescriptions[category]}
                </p>
              )}
            </div>
            <div class="features-grid">
              {categoryFeatures.map((feature) => (
                <Card href={`/features/${feature.slug}`}>
                  <div class="card-header">
                    <Badge audience={feature.data.audience} />
                    {feature.data.comingSoon && (
                      <span class="coming-soon">Coming Soon</span>
                    )}
                  </div>
                  <h3>{feature.data.title}</h3>
                  <p class="summary">{feature.data.summary}</p>
                  {feature.data.supportedStandards &&
                    feature.data.supportedStandards.length > 0 && (
                      <div class="standards">
                        {feature.data.supportedStandards
                          .slice(0, 2)
                          .map((std) => (
                            <span class="standard-tag">{std}</span>
                          ))}
                      </div>
                    )}
                </Card>
              ))}
            </div>
          </section>
        ))
      }

      <!-- CTA -->
      <section class="cta-section">
        <h2>Ready to Build?</h2>
        <p>
          Explore the documentation to learn how to integrate these features
          into your application.
        </p>
        <div class="cta-buttons">
          <a href="/docs" class="btn btn-primary">Get Started</a>
          <a
            href="https://github.com/iTowns/itowns"
            target="_blank"
            rel="noopener noreferrer"
            class="btn btn-outline"
          >
            View on GitHub
          </a>
        </div>
      </section>
    </div>
  </div>
</PageLayout>

<style>
  .features-page {
    padding: var(--space-8) 0;
  }

  .page-header {
    text-align: center;
    max-width: 800px;
    margin: 0 auto var(--space-9);
  }

  .page-description {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
    line-height: var(--leading-relaxed);
  }

  /* Featured Section */
  .featured-section {
    margin-bottom: var(--space-9);
  }

  .featured-section h2 {
    margin-bottom: var(--space-5);
  }

  .featured-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: var(--space-5);
  }

  .featured-card {
    display: block;
    padding: var(--space-5);
    background: linear-gradient(
      135deg,
      var(--color-bg-secondary) 0%,
      var(--color-bg-primary) 100%
    );
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .featured-card:hover {
    border-color: var(--color-accent-primary);
    box-shadow: var(--shadow-md);
    text-decoration: none;
  }

  .featured-meta {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-3);
  }

  .category-tag {
    padding: var(--space-1) var(--space-2);
    background-color: var(--color-accent-light);
    color: var(--color-accent-primary);
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: 500;
  }

  .coming-soon {
    padding: var(--space-1) var(--space-2);
    background-color: rgba(234, 179, 8, 0.15);
    color: #ca8a04;
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: 600;
  }

  .featured-card h3 {
    font-size: var(--text-xl);
    margin-bottom: var(--space-2);
    color: var(--color-text-primary);
  }

  .featured-card p {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-3);
    line-height: var(--leading-relaxed);
  }

  .capabilities-preview {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .capabilities-preview li {
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
    padding-left: var(--space-4);
    position: relative;
    margin-bottom: var(--space-1);
  }

  .capabilities-preview li::before {
    content: 'âœ“';
    position: absolute;
    left: 0;
    color: var(--color-success);
  }

  /* Category Sections */
  .category-section {
    margin-bottom: var(--space-9);
  }

  .category-header {
    margin-bottom: var(--space-5);
  }

  .category-header h2 {
    margin-bottom: var(--space-2);
  }

  .category-description {
    color: var(--color-text-secondary);
  }

  .features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--space-5);
  }

  .card-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-3);
  }

  .features-grid h3 {
    font-size: var(--text-lg);
    margin-bottom: var(--space-2);
  }

  .summary {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-3);
    line-height: var(--leading-relaxed);
  }

  .standards {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .standard-tag {
    padding: var(--space-1) var(--space-2);
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
  }

  /* CTA Section */
  .cta-section {
    text-align: center;
    padding: var(--space-8);
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
  }

  .cta-section h2 {
    margin-bottom: var(--space-4);
  }

  .cta-section p {
    color: var(--color-text-secondary);
    max-width: 600px;
    margin: 0 auto var(--space-6);
  }

  .cta-buttons {
    display: flex;
    gap: var(--space-4);
    justify-content: center;
  }

  .btn {
    padding: var(--space-3) var(--space-5);
    border-radius: var(--radius-md);
    font-weight: 500;
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .btn-primary {
    background-color: var(--color-accent-primary);
    color: white;
  }

  .btn-primary:hover {
    background-color: var(--color-accent-secondary);
  }

  .btn-outline {
    border: 1px solid var(--color-border);
    color: var(--color-text-primary);
  }

  .btn-outline:hover {
    border-color: var(--color-accent-primary);
    color: var(--color-accent-primary);
  }

  @media (max-width: 768px) {
    .featured-grid,
    .features-grid {
      grid-template-columns: 1fr;
    }

    .cta-buttons {
      flex-direction: column;
      align-items: center;
    }
  }
</style>

